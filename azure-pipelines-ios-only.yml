pool:
  name: Default  # Replace with your self-hosted agent pool name

variables:
  flutterVersion: '3.5.3'  # Specify the Flutter version
  buildConfiguration: 'Release'  # Build configuration (Debug, Release)

steps:
# Install Flutter
- script: |
    git clone -b ${flutterVersion} --depth 1 https://github.com/flutter/flutter.git
    echo '##vso[task.prependpath]$(Pipeline.Workspace)/flutter/bin'
    flutter doctor
  displayName: 'Install Flutter'

# Install Dependencies
- script: flutter pub get
  displayName: 'Install Dependencies'

# Build iOS App Without Signing
- script: |
    flutter build ios --release --no-codesign
  displayName: 'Build iOS App (Unsigned)'

# Package IPA Without Signing
- script: |
    mkdir -p build/ios/ipa
    xcodebuild -workspace ios/Runner.xcworkspace \
               -scheme Runner \
               -sdk iphoneos \
               -configuration ${buildConfiguration} \
               archive -archivePath build/ios/Runner.xcarchive CODE_SIGNING_ALLOWED=NO

    xcodebuild -exportArchive \
               -archivePath build/ios/Runner.xcarchive \
               -exportPath build/ios/ipa \
               -exportOptionsPlist ios/ExportOptions.plist \
               CODE_SIGNING_ALLOWED=NO
  displayName: 'Package Unsigned IPA'

# Publish IPA Artifact
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'build/ios/ipa'
    artifact: 'UnsignedIPA'
    publishLocation: 'pipeline'
  displayName: 'Publish IPA Artifact'
